<!-- index.ejs -->

<html lang="en">

<%- include('./partials/head.ejs') %>
    <%- include('./partials/nav.ejs') %>

        <body>
            <div id="searchContainer">
                <h1>List of Flights</h1>
                <form id="searchForm">
                    <input type="text" name="query" id="searchInput" placeholder="Search flights">
                    <button type="submit">Search</button>
                </form>
            </div>
            <div id="flightsContainer" style="display: flex;">
                <ul id="flightsList">
                </ul>

                <div id="flightDetails" style="margin-left: 20px;">
                </div>
            </div>

            <p id="noFlightsMessage" style="display: none;">No flights available.</p>

            <a href="/flights">Back to Flights</a>

            <script>
                async function fetchAndRenderFlights(query) {
                    try {
                        const response = await fetch(`/api/flights/search?query=${encodeURIComponent(query)}`);
                        if (!response.ok) {
                            throw new Error(`Error: ${response.status} - ${response.statusText}`);
                        }
                        const results = await response.json();

                        const flightsList = document.getElementById('flightsList');
                        const noFlightsMessage = document.getElementById('noFlightsMessage');

                        if (results && results.length > 0) {
                            flightsList.innerHTML = results.map(flight => `
                    <li>
                        <strong>Flight Number:</strong> ${flight.flight_no}<br>
                        <strong>Destination:</strong> ${flight.arrival_airport}<br>
                        <strong>Departure Time:</strong> ${flight.scheduled_departure}<br>
                        <br>
                        <strong>Status:</strong> ${flight.status}<br>
                        <button type="button" onclick="showFlightDetails('${flight.flight_id}')">Show Details</button>
                    </li>
                `).join('');
                        } else {
                            noFlightsMessage.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Error fetching flights:', error);
                    }
                }


                // Asynchronously fetch flight data after page load
                async function fetchFlights() {
                    try {
                        const response = await fetch('/api/flights');
                        const flights = await response.json();

                        const flightsList = document.getElementById('flightsList');
                        const flightDetailsContainer = document.getElementById('flightDetails');
                        const noFlightsMessage = document.getElementById('noFlightsMessage');

                        if (flights && flights.length > 0) {
                            flightsList.innerHTML = flights.map(flight => `
                        <li>
                            <strong>Flight Number:</strong> ${flight.flight_no}<br>
                            <strong>Destination:</strong> ${flight.arrival_airport}<br>
                            <strong>Departure Time:</strong> ${flight.scheduled_departure}<br>
                            <br>
                            <strong>Status:</strong> ${flight.status}<br>
                            <button type="button" onclick="showFlightDetails('${flight.flight_id}')">Show Details</button>
                        </li>
                    `).join('');
                        } else {
                            noFlightsMessage.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Error fetching flights:', error);
                    }
                }

                // Function to fetch and display flight details
                async function showFlightDetails(flightId) {
                    try {
                        const response = await fetch(`/api/flights/${flightId}`);
                        const flightDetails = await response.json();

                        const flightDetailsContainer = document.getElementById('flightDetails');
                        flightDetailsContainer.innerHTML = `
                    <h2>Flight Details</h2>
                    <ul>
                        <li><strong>Flight Number:</strong> ${flightDetails.flight_no}</li>
                        <li><strong>Destination:</strong> ${flightDetails.arrival_airport}</li>
                        <li><strong>Departure Time:</strong> ${flightDetails.scheduled_departure}</li>
                         ${flightDetails.status === "Arrived" ? `<li><strong>Status:</strong> <span style="color: green;">${flightDetails.status}</span></li>` : ''}
                         ${flightDetails.status === "Scheduled" ? `<li><strong>Status:</strong> <span style="color: yellow;">${flightDetails.status}</span></li>` : ''}
                         ${flightDetails.status === "On Time" ? `<li><strong>Status:</strong> <span style="color: lightgreen;">${flightDetails.status}</span></li>` : ''}
                         ${flightDetails.status === "Delayed" ? `<li><strong>Status:</strong> <span style="color: red;">${flightDetails.status}</span></li>` : ''}
                         
            </ul>
        `;
                    flightDetailsContainer.style.display = 'block';

                    } catch (error) {
                        console.error('Error fetching flight details:', error);
                    }
                }

                document.addEventListener('DOMContentLoaded', fetchFlights);
                document.addEventListener('DOMContentLoaded', () => {
    const flightDetailsContainer = document.getElementById('flightDetails');
    flightDetailsContainer.style.display = 'none';
});

document.getElementById('searchForm').addEventListener('submit', function (event) {
    event.preventDefault();
    const query = document.getElementById('searchInput').value;
    fetchAndRenderFlights(query);
});
            </script>

        </body>
        <%- include('./partials/foot.ejs') %>

</html>